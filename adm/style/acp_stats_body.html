<!-- INCLUDE overall_header.html -->

<h1>{L_ACP_STATS}</h1>
<p>{L_ACP_STATS_EXPLAIN}</p>

<style>
/* === STYLES GLOBAUX === */
.stats-dashboard { margin: 20px 0; }

/* Cartes de statistiques */
.stats-cards { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; }
.stat-card { flex: 1; min-width: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.stat-card.bots { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.stat-card.humans { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.stat-card.pages { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.stat-card.duration { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.stat-card .number { font-size: 32px; font-weight: bold; }
.stat-card .label { font-size: 12px; opacity: 0.9; text-transform: uppercase; }

/* Filtres */
.filters-bar { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
.filters-bar label { font-weight: bold; margin-right: 5px; }
.filters-bar select, .filters-bar input[type="checkbox"] { margin-right: 15px; }

/* Onglets */
.tab-container { margin-top: 20px; }
.tab-buttons { overflow: hidden; border-bottom: 2px solid #105289; display: flex; }
.tab-btn { background: #f1f1f1; border: none; outline: none; cursor: pointer; padding: 12px 25px; font-size: 14px; border-radius: 8px 8px 0 0; margin-right: 3px; transition: all 0.2s; }
.tab-btn:hover { background: #e0e0e0; }
.tab-btn.active { background: #105289; color: #fff; font-weight: bold; }
.tab-content { display: none; padding: 20px; border: 1px solid #ddd; border-top: none; background: #fff; border-radius: 0 0 8px 8px; }

/* Graphes CSS */
.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
.chart-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; }
.chart-box h4 { margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #105289; color: #333; }
.stat-row { margin-bottom: 8px; display: flex; align-items: center; }
.stat-label { width: 35%; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
.stat-bar-container { flex: 1; background: #eee; height: 20px; border-radius: 4px; overflow: hidden; }
.stat-bar { height: 100%; text-align: right; color: #fff; font-size: 11px; line-height: 20px; padding-right: 5px; white-space: nowrap; min-width: 25px; border-radius: 4px; }
.stat-count { width: 50px; text-align: right; font-weight: bold; font-size: 12px; padding-left: 10px; }

/* Couleurs des barres */
.bar-blue { background: linear-gradient(90deg, #105289, #1a73e8); }
.bar-orange { background: linear-gradient(90deg, #d35400, #e67e22); }
.bar-green { background: linear-gradient(90deg, #27ae60, #2ecc71); }
.bar-purple { background: linear-gradient(90deg, #8e44ad, #9b59b6); }
.bar-red { background: linear-gradient(90deg, #c0392b, #e74c3c); }

/* Tableau sessions */
.sessions-table { width: 100%; border-collapse: collapse; }
.sessions-table th { background: #105289; color: #fff; padding: 12px; text-align: left; }
.sessions-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; }
.sessions-table tr:hover { background: #f9f9f9; }
.sessions-table .session-row { background: #f5f5f5; border-top: 2px solid #ddd; }
.sessions-table .page-row td { padding-left: 40px; font-size: 13px; color: #666; }

/* Badges */
.badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
.badge-bot { background: #e74c3c; color: #fff; }
.badge-bot-phpbb { background: #27ae60; color: #fff; }
.badge-bot-detected { background: #e67e22; color: #fff; }
.badge-human { background: #3498db; color: #fff; }
.badge-member { background: #9b59b6; color: #fff; }
.badge-referer { background: #8e44ad; color: #fff; }

/* Session info */
.session-info { line-height: 1.6; }
.session-info .ip { font-family: monospace; font-weight: bold; }
.session-info .time { color: #666; font-size: 12px; }
.session-tech { font-size: 12px; color: #555; }
.session-tech .ua { cursor: help; border-bottom: 1px dotted #999; }

/* Pages count */
.page-count { background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 11px; }

/* Referer */
.referer-cell { max-width: 250px; word-wrap: break-word; font-size: 12px; }
.referer-cell a { color: #105289; }
.direct { color: #999; font-style: italic; }
</style>

<!-- Filtres -->
<div class="filters-bar">
    <div>
        <label>{L_STATS_PERIOD}</label>
        <select id="filter-hours" onchange="applyFilters()">
            <option value="1"<!-- IF FILTER_HOURS == 1 --> selected<!-- ENDIF -->>{L_STATS_1_HOUR}</option>
            <option value="6"<!-- IF FILTER_HOURS == 6 --> selected<!-- ENDIF -->>{L_STATS_6_HOURS}</option>
            <option value="12"<!-- IF FILTER_HOURS == 12 --> selected<!-- ENDIF -->>{L_STATS_12_HOURS}</option>
            <option value="24"<!-- IF FILTER_HOURS == 24 --> selected<!-- ENDIF -->>{L_STATS_24_HOURS}</option>
            <option value="48"<!-- IF FILTER_HOURS == 48 --> selected<!-- ENDIF -->>{L_STATS_48_HOURS}</option>
            <option value="168"<!-- IF FILTER_HOURS == 168 --> selected<!-- ENDIF -->>{L_STATS_7_DAYS}</option>
            <option value="720"<!-- IF FILTER_HOURS == 720 --> selected<!-- ENDIF -->>{L_STATS_30_DAYS}</option>
        </select>
    </div>
    <div>
        <label><input type="checkbox" id="filter-bots" value="1"<!-- IF SHOW_BOTS --> checked<!-- ENDIF --> onchange="applyFilters()"> {L_STATS_SHOW_BOTS}</label>
    </div>
    <div>
        <label>{L_STATS_LIMIT}</label>
        <select id="filter-limit" onchange="applyFilters()">
            <option value="50"<!-- IF DISPLAY_LIMIT == 50 --> selected<!-- ENDIF -->>50</option>
            <option value="100"<!-- IF DISPLAY_LIMIT == 100 --> selected<!-- ENDIF -->>100</option>
            <option value="250"<!-- IF DISPLAY_LIMIT == 250 --> selected<!-- ENDIF -->>250</option>
            <option value="500"<!-- IF DISPLAY_LIMIT == 500 --> selected<!-- ENDIF -->>500</option>
            <option value="1000"<!-- IF DISPLAY_LIMIT == 1000 --> selected<!-- ENDIF -->>1 000</option>
            <option value="2000"<!-- IF DISPLAY_LIMIT == 2000 --> selected<!-- ENDIF -->>2 000</option>
            <option value="5000"<!-- IF DISPLAY_LIMIT == 5000 --> selected<!-- ENDIF -->>5 000</option>
        </select>
    </div>
</div>

<!-- Cartes de statistiques -->
<div class="stats-cards">
    <div class="stat-card pages">
        <div class="number">{TOTAL_PAGEVIEWS}</div>
        <div class="label">{L_STATS_PAGEVIEWS_HUMANS}</div>
    </div>
    <div class="stat-card humans">
        <div class="number">{UNIQUE_VISITORS}</div>
        <div class="label">{L_STATS_UNIQUE_VISITORS}</div>
    </div>
    <div class="stat-card duration">
        <div class="number">{AVG_DURATION_HUMANS}</div>
        <div class="label">{L_STATS_AVG_DURATION_HUMANS}</div>
    </div>
    <div class="stat-card bots">
        <div class="number">{TOTAL_BOTS}</div>
        <div class="label">{L_STATS_UNIQUE_BOTS}</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
        <div class="number">{BOT_PAGEVIEWS}</div>
        <div class="label">{L_STATS_BOT_PAGEVIEWS_LABEL}</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
        <div class="number">{AVG_DURATION_BOTS}</div>
        <div class="label">{L_STATS_AVG_DURATION_BOTS}</div>
    </div>
</div>

<!-- Onglets -->
<div class="tab-container">
    <div class="tab-buttons">
        <button class="tab-btn active" onclick="openTab(event, 'tab_dashboard')">{L_STATS_TAB_OVERVIEW}</button>
        <button class="tab-btn" onclick="openTab(event, 'tab_sessions')">{L_STATS_TAB_SESSIONS}</button>
        <button class="tab-btn" onclick="openTab(event, 'tab_pages')">{L_STATS_TAB_PAGES}</button>
        <button class="tab-btn" onclick="openTab(event, 'tab_map')">{L_STATS_TAB_MAP}</button>
    </div>

    <!-- ONGLET 1 : DASHBOARD -->
    <div id="tab_dashboard" class="tab-content" style="display: block;">
        <div class="charts-grid">
            <!-- Sources de trafic HUMAINS -->
            <div class="chart-box">
                <h4 style="color:#3498db;">{L_STATS_TRAFFIC_HUMANS}</h4>
                <!-- BEGIN STATS_REFERER_HUMANS -->
                <div class="stat-row">
                    <div class="stat-label" title="{STATS_REFERER_HUMANS.NAME}">{STATS_REFERER_HUMANS.NAME}</div>
                    <div class="stat-bar-container"><div class="stat-bar bar-blue" style="width:{STATS_REFERER_HUMANS.PERCENT}%"></div></div>
                    <div class="stat-count">{STATS_REFERER_HUMANS.COUNT}</div>
                </div>
                <!-- END STATS_REFERER_HUMANS -->
                <!-- IF not STATS_REFERER_HUMANS --><p style="color:#999; text-align:center;">{L_STATS_NO_DATA}</p><!-- ENDIF -->
            </div>

            <!-- Sources de trafic BOTS -->
            <div class="chart-box">
                <h4 style="color:#e74c3c;">{L_STATS_TRAFFIC_BOTS}</h4>
                <!-- BEGIN STATS_REFERER_BOTS -->
                <div class="stat-row">
                    <div class="stat-label" title="{STATS_REFERER_BOTS.NAME}">{STATS_REFERER_BOTS.NAME}</div>
                    <div class="stat-bar-container"><div class="stat-bar bar-red" style="width:{STATS_REFERER_BOTS.PERCENT}%"></div></div>
                    <div class="stat-count">{STATS_REFERER_BOTS.COUNT}</div>
                </div>
                <!-- END STATS_REFERER_BOTS -->
                <!-- IF not STATS_REFERER_BOTS --><p style="color:#999; text-align:center;">{L_STATS_NO_DATA}</p><!-- ENDIF -->
            </div>

            <!-- OS -->
            <div class="chart-box">
                <h4>{L_STATS_OS_TITLE}</h4>
                <!-- BEGIN STATS_OS -->
                <div class="stat-row">
                    <div class="stat-label">{STATS_OS.NAME}</div>
                    <div class="stat-bar-container"><div class="stat-bar bar-orange" style="width:{STATS_OS.PERCENT}%"></div></div>
                    <div class="stat-count">{STATS_OS.COUNT}</div>
                </div>
                <!-- END STATS_OS -->
                <!-- IF not STATS_OS --><p style="color:#999; text-align:center;">{L_STATS_NO_DATA}</p><!-- ENDIF -->
            </div>

            <!-- Appareils -->
            <div class="chart-box">
                <h4>{L_STATS_DEVICES_TITLE}</h4>
                <!-- BEGIN STATS_DEVICE -->
                <div class="stat-row">
                    <div class="stat-label">{STATS_DEVICE.NAME}</div>
                    <div class="stat-bar-container"><div class="stat-bar bar-green" style="width:{STATS_DEVICE.PERCENT}%"></div></div>
                    <div class="stat-count">{STATS_DEVICE.COUNT}</div>
                </div>
                <!-- END STATS_DEVICE -->
                <!-- IF not STATS_DEVICE --><p style="color:#999; text-align:center;">{L_STATS_NO_DATA}</p><!-- ENDIF -->
            </div>

            <!-- Resolutions -->
            <div class="chart-box">
                <h4>{L_STATS_RES_TITLE}</h4>
                <!-- BEGIN STATS_RES -->
                <div class="stat-row">
                    <div class="stat-label">{STATS_RES.NAME}</div>
                    <div class="stat-bar-container"><div class="stat-bar bar-purple" style="width:{STATS_RES.PERCENT}%"></div></div>
                    <div class="stat-count">{STATS_RES.COUNT}</div>
                </div>
                <!-- END STATS_RES -->
                <!-- IF not STATS_RES --><p style="color:#999; text-align:center;">{L_STATS_NO_DATA}</p><!-- ENDIF -->
            </div>
        </div>

        <!-- Referers complets cliquables -->
        <div class="chart-box" style="margin-top:20px;">
            <h4>{L_STATS_FULL_REFERERS}</h4>
            <table class="sessions-table" style="font-size:13px;">
                <thead>
                    <tr>
                        <th style="width:35%">{L_STATS_COL_SOURCE_REFERER}</th>
                        <th style="width:30%">{L_STATS_COL_DESTINATION}</th>
                        <th style="width:10%">{L_STATS_COL_TYPE}</th>
                        <th style="width:8%">{L_STATS_COL_VISITS}</th>
                        <th style="width:7%">{L_STATS_COL_SOURCE}</th>
                    </tr>
                </thead>
                <tbody>
                <!-- BEGIN FULL_REFERERS -->
                    <tr>
                        <td><a href="{FULL_REFERERS.URL}" target="_blank" rel="noopener" style="color:#105289; word-break:break-all;">{FULL_REFERERS.DISPLAY}</a></td>
                        <td><a href="{FULL_REFERERS.DEST_URL}" target="_blank" style="color:#666; word-break:break-all;">{FULL_REFERERS.DEST_TITLE}</a></td>
                        <td><span class="badge badge-referer">{FULL_REFERERS.TYPE}</span></td>
                        <td style="text-align:center; font-weight:bold;">{FULL_REFERERS.COUNT}</td>
                        <td style="text-align:center;"><!-- IF FULL_REFERERS.IS_BOT --><span class="badge badge-bot">{L_STATS_LABEL_BOT}</span><!-- ELSE --><span class="badge badge-human">{L_STATS_LABEL_HUMAN}</span><!-- ENDIF --></td>
                    </tr>
                <!-- BEGINELSE -->
                    <tr><td colspan="5" style="text-align:center; color:#999; padding:20px;">{L_STATS_NO_EXTERNAL_REFERER}</td></tr>
                <!-- END FULL_REFERERS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ONGLET 2 : SESSIONS -->
    <div id="tab_sessions" class="tab-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="display:flex; gap:15px; align-items:center;">
                <label style="font-weight:bold; cursor:pointer;"><input type="checkbox" id="filter-sessions-humans" checked onchange="filterSessions()"> <span class="badge badge-human">{L_STATS_FILTER_HUMANS}</span></label>
                <label style="font-weight:bold; cursor:pointer;"><input type="checkbox" id="filter-sessions-bots" checked onchange="filterSessions()"> <span class="badge badge-bot">{L_STATS_FILTER_ROBOTS}</span></label>
            </div>
            <form method="post" action="{U_ACTION}" style="margin:0;">
                <input type="submit" name="submit_clear" value="{L_ACP_BASTIEN59_STATS_CLEAR}" class="button2" onclick="return confirm('{L_ACP_BASTIEN59_STATS_CONFIRM}');" />
                {S_FORM_TOKEN}
            </form>
        </div>

        <table class="sessions-table" id="sessions-table">
            <thead>
                <tr>
                    <th style="width:20%">{L_STATS_COL_VISITOR}</th>
                    <th style="width:15%">{L_STATS_COL_DEVICE}</th>
                    <th style="width:30%">{L_STATS_COL_LANDING_PAGE}</th>
                    <th style="width:15%">{L_STATS_COL_SOURCE}</th>
                    <th style="width:10%">{L_STATS_COL_PAGES}</th>
                </tr>
            </thead>
            <tbody>
            <!-- BEGIN SESSIONS -->
                <tr class="session-row session-{SESSIONS.BOT_CLASS}" data-type="{SESSIONS.BOT_CLASS}" onclick="toggleDetails(this)" style="cursor: pointer;" title="Cliquez pour voir les détails de diagnostic">
                    <td class="session-info">
                        <!-- IF SESSIONS.IS_BOT -->
                            <span class="badge badge-bot">{L_STATS_BADGE_BOT}</span>
                            <!-- IF SESSIONS.IS_PHPBB_BOT --><span class="badge badge-bot-phpbb">{L_STATS_BADGE_PHPBB}</span><!-- ELSEIF SESSIONS.BOT_SOURCE == "behavior" --><span class="badge badge-bot-detected" title="{L_STATS_BADGE_BEHAVIOR_TITLE}">{L_STATS_BADGE_BEHAVIOR}</span><!-- ELSE --><span class="badge badge-bot-detected" title="{L_STATS_BADGE_UA_TITLE}">{L_STATS_BADGE_UA}</span><!-- ENDIF -->
                        <!-- ELSE -->
                            <span class="badge badge-human">{L_STATS_LABEL_HUMAN}</span>
                            <!-- IF SESSIONS.IS_GUEST --><span class="badge" style="background:#95a5a6; color:#fff;">{L_STATS_BADGE_GUEST}</span><!-- ENDIF -->
                        <!-- ENDIF -->
                        <!-- IF SESSIONS.USERNAME != "Invite" --><span class="badge badge-member">{SESSIONS.USERNAME}</span><!-- ENDIF -->
                        <br>
                        <span class="ip">{SESSIONS.IP}</span>
                        <!-- IF SESSIONS.COUNTRY --><br><span style="font-size:14px;">{SESSIONS.COUNTRY}</span><!-- ENDIF -->
                        <!-- IF SESSIONS.HOSTNAME --><br><small style="color:#888; font-size:10px;" title="{SESSIONS.HOSTNAME}">{SESSIONS.HOSTNAME}</small><!-- ENDIF -->
                        <br>
                        <span class="time">{SESSIONS.START_TIME}</span>
                    </td>
                    <td class="session-tech">
                        <!-- IF SESSIONS.IS_BOT -->
                        <strong style="color:#e74c3c;">{SESSIONS.BOT_NAME}</strong><br>
                        <small style="word-break:break-all; color:#666; font-size:10px;">{SESSIONS.USER_AGENT}</small>
                        <!-- ELSE -->
                        <strong>{SESSIONS.OS}</strong> | {SESSIONS.DEVICE} | {SESSIONS.RES}<br>
                        <small style="word-break:break-all; color:#666; font-size:10px;">{SESSIONS.USER_AGENT}</small>
                        <!-- ENDIF -->
                    </td>
                    <td>
                        <strong>{SESSIONS.LANDING_PAGE}</strong><br>
                        <a href="{SESSIONS.LANDING_URL}" target="_blank" style="font-size:11px; color:#666; word-break:break-all;">{SESSIONS.LANDING_URL}</a>
                    </td>
                    <td class="referer-cell">
                        <span class="badge badge-referer">{SESSIONS.REFERER_TYPE}</span><br>
                        <small>{SESSIONS.REFERER}</small>
                    </td>
                    <td style="text-align:center">
                        <span class="page-count">{SESSIONS.PAGES_COUNT_LABEL}</span>
                    </td>
                </tr>
                <tr class="session-details-row session-{SESSIONS.BOT_CLASS}" data-type="{SESSIONS.BOT_CLASS}" style="display: none;">
                    <td colspan="5" style="padding: 10px 20px 10px 40px; background: #fdfdfd; font-size: 12px; line-height: 1.7; border-bottom: 1px solid #eee;">
                        <div style="max-width: 90%;">
                            <strong style="color: #105289;">Informations de Diagnostic</strong><br>
                            <strong>Reverse DNS :</strong> <!-- IF SESSIONS.HOSTNAME -->{SESSIONS.HOSTNAME}<!-- ELSE --><span style="color:#999;">Aucun nom d'hôte trouvé.</span><!-- ENDIF --><br>
                            <strong>Forward DNS :</strong> {SESSIONS.FORWARD_DNS_STATUS}<!-- IF SESSIONS.FORWARD_DNS_IPS --> (IPs: {SESSIONS.FORWARD_DNS_IPS})<!-- ENDIF -->

                            <!-- IF SESSIONS.IS_BOT -->
                                <br><br>
                                <strong style="color: #c0392b;">Analyse de Détection de Bot</strong>
                                <ul style="margin: 5px 0 0 20px; padding: 0; list-style-type: square;">
                                    <!-- IF SESSIONS.BOT_SOURCE == 'phpbb' -->
                                        <li><strong>Source :</strong> Liste de bots phpBB</li>
                                        <li><strong>Verdict :</strong> Bot légitime (ex: Googlebot, Bingbot). N'est jamais bloqué.</li>
                                    <!-- ELSEIF SESSIONS.BOT_SOURCE == 'extension' -->
                                        <li><strong>Source :</strong> Liste de l'extension (basée sur le User-Agent)</li>
                                        <li><strong>Verdict :</strong> Bot dont la signature est connue. Peut être légitime ou malveillant. Signalé pour surveillance.</li>
                                    <!-- ELSEIF SESSIONS.BOT_SOURCE == 'behavior' -->
                                        <li><strong>Source :</strong> Comportement suspect</li>
                                        <li><strong>Verdict :</strong> Comportement non-humain détecté (ex: absence de JavaScript, accès direct à des pages de formulaire). Signalé pour surveillance.</li>
                                    <!-- ELSE -->
                                        <li><strong>Source :</strong> Inconnue</li>
                                    <!-- ENDIF -->
                                </ul>
                            <!-- ENDIF -->
                        </div>
                    </td>
                </tr>
                <!-- BEGIN PAGES -->
                <tr class="page-row session-{SESSIONS.BOT_CLASS}" data-type="{SESSIONS.BOT_CLASS}">
                    <td style="text-align:right; color:#888;">
                        &#8627; {SESSIONS.PAGES.TIME}
                    </td>
                    <td style="color:#888; font-size:11px;">{SESSIONS.PAGES.DURATION}</td>
                    <td colspan="3">
                        <strong>{SESSIONS.PAGES.TITLE}</strong><br>
                        <a href="{SESSIONS.PAGES.URL}" target="_blank" style="font-size:11px; color:#888; word-break:break-all;">{SESSIONS.PAGES.URL}</a>
                    </td>
                </tr>
                <!-- END PAGES -->
            <!-- BEGINELSE -->
                <tr>
                    <td colspan="5" style="text-align:center; padding: 40px; color: #999;">
                        <strong>{L_STATS_NO_SESSION}</strong><br>
                        {L_STATS_NO_SESSION_EXPLAIN}
                    </td>
                </tr>
            <!-- END SESSIONS -->
            </tbody>
        </table>
    </div>

    <!-- ONGLET 3 : TOP PAGES -->
    <div id="tab_pages" class="tab-content">
        <h3>{L_STATS_TOP_PAGES}</h3>
        <table class="sessions-table">
            <thead>
                <tr>
                    <th>{L_STATS_COL_PAGE}</th>
                    <th style="width:15%">{L_STATS_COL_VISITS}</th>
                    <th style="width:15%">{L_STATS_COL_AVG_TIME}</th>
                </tr>
            </thead>
            <tbody>
            <!-- BEGIN TOP_PAGES -->
                <tr>
                    <td><a href="{TOP_PAGES.URL}" target="_blank">{TOP_PAGES.TITLE}</a></td>
                    <td style="text-align:center"><strong>{TOP_PAGES.VISITS}</strong></td>
                    <td style="text-align:center">{TOP_PAGES.AVG_TIME}</td>
                </tr>
            <!-- BEGINELSE -->
                <tr>
                    <td colspan="3" style="text-align:center; padding: 40px; color: #999;">
                        {L_STATS_NO_PAGE_DATA}
                    </td>
                </tr>
            <!-- END TOP_PAGES -->
            </tbody>
        </table>
    </div>

    <!-- ONGLET 4 : CARTE -->
    <div id="tab_map" class="tab-content">
        <!-- CARTE HUMAINS -->
        <h3 style="color:#3498db;">{L_STATS_MAP_HUMANS}</h3>
        <div class="chart-box" style="margin-bottom:20px;">
            <div id="world-map-humans" style="width:100%; height:400px; background:#f8fafc;"></div>
            <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px;">
                <span style="font-size:12px; color:#666;">{L_STATS_LEGEND}</span>
                <span style="display:inline-block; width:20px; height:12px; background:#bbdefb; border:1px solid #90caf9;"></span>
                <span style="font-size:11px;">{L_STATS_LEGEND_LOW}</span>
                <span style="display:inline-block; width:20px; height:12px; background:#42a5f5; border:1px solid #1e88e5;"></span>
                <span style="font-size:11px;">{L_STATS_LEGEND_MEDIUM}</span>
                <span style="display:inline-block; width:20px; height:12px; background:#1565c0; border:1px solid #0d47a1;"></span>
                <span style="font-size:11px;">{L_STATS_LEGEND_HIGH}</span>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-box">
                <h4 style="color:#3498db;">{L_STATS_TOP_COUNTRIES_HUMANS}</h4>
                <!-- BEGIN STATS_COUNTRY_HUMANS -->
                <div class="stat-row">
                    <div class="stat-label" style="width:45%;">
                        <span style="font-size:18px;">{STATS_COUNTRY_HUMANS.FLAG}</span>
                        {STATS_COUNTRY_HUMANS.NAME}
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar bar-blue" style="width:{STATS_COUNTRY_HUMANS.PERCENT}%"></div>
                    </div>
                    <div class="stat-count">{STATS_COUNTRY_HUMANS.VISITORS}</div>
                </div>
                <!-- END STATS_COUNTRY_HUMANS -->
                <!-- IF not STATS_COUNTRY_HUMANS --><p style="color:#999; text-align:center;">{L_STATS_NO_DATA}</p><!-- ENDIF -->
            </div>
            <div class="chart-box">
                <h4>{L_STATS_DISTRIBUTION_HUMANS}</h4>
                <p style="color:#666; font-size:13px; line-height:1.8;">
                    <strong>{L_STATS_TOTAL_COUNTRIES}</strong> <span id="total-countries-humans">0</span><br>
                    <strong>{L_STATS_GEOLOCATED_VISITORS}</strong> <span id="total-geolocated-humans">0</span>
                </p>
            </div>
        </div>

        <!-- CARTE BOTS -->
        <h3 style="color:#e74c3c; margin-top:30px;">{L_STATS_MAP_BOTS}</h3>
        <div class="chart-box" style="margin-bottom:20px;">
            <div id="world-map-bots" style="width:100%; height:400px; background:#fff5f5;"></div>
            <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:10px; padding:10px; background:#f5f5f5; border-radius:5px;">
                <span style="font-size:12px; color:#666;">{L_STATS_LEGEND}</span>
                <span style="display:inline-block; width:20px; height:12px; background:#ffcdd2; border:1px solid #ef9a9a;"></span>
                <span style="font-size:11px;">{L_STATS_LEGEND_LOW}</span>
                <span style="display:inline-block; width:20px; height:12px; background:#ef5350; border:1px solid #e53935;"></span>
                <span style="font-size:11px;">{L_STATS_LEGEND_MEDIUM}</span>
                <span style="display:inline-block; width:20px; height:12px; background:#b71c1c; border:1px solid #880e0e;"></span>
                <span style="font-size:11px;">{L_STATS_LEGEND_HIGH}</span>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-box">
                <h4 style="color:#e74c3c;">{L_STATS_TOP_COUNTRIES_BOTS}</h4>
                <!-- BEGIN STATS_COUNTRY_BOTS -->
                <div class="stat-row">
                    <div class="stat-label" style="width:45%;">
                        <span style="font-size:18px;">{STATS_COUNTRY_BOTS.FLAG}</span>
                        {STATS_COUNTRY_BOTS.NAME}
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar bar-red" style="width:{STATS_COUNTRY_BOTS.PERCENT}%"></div>
                    </div>
                    <div class="stat-count">{STATS_COUNTRY_BOTS.VISITORS}</div>
                </div>
                <!-- END STATS_COUNTRY_BOTS -->
                <!-- IF not STATS_COUNTRY_BOTS --><p style="color:#999; text-align:center;">{L_STATS_NO_DATA}</p><!-- ENDIF -->
            </div>
            <div class="chart-box">
                <h4>{L_STATS_DISTRIBUTION_BOTS}</h4>
                <p style="color:#666; font-size:13px; line-height:1.8;">
                    <strong>{L_STATS_TOTAL_COUNTRIES}</strong> <span id="total-countries-bots">0</span><br>
                    <strong>{L_STATS_GEOLOCATED_BOTS}</strong> <span id="total-geolocated-bots">0</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Scripts (chargés APRES overall_footer.html qui inclut jQuery) -->
<!-- INCLUDE overall_footer.html -->

<script>
function toggleDetails(row) {
    var nextRow = row.nextElementSibling;
    if (nextRow && nextRow.classList.contains('session-details-row')) {
        // Hide all other open details rows
        var allDetails = document.querySelectorAll('.session-details-row');
        for (var i = 0; i < allDetails.length; i++) {
            if (allDetails[i] !== nextRow) {
                allDetails[i].style.display = 'none';
            }
        }
        // Toggle the clicked one
        nextRow.style.display = (nextRow.style.display === 'none' || nextRow.style.display === '') ? 'table-row' : 'none';
    }
}

// Donnees par pays (generees par PHP)
var mapDataHumans = {MAP_DATA_HUMANS_JSON};
var mapDataBots = {MAP_DATA_BOTS_JSON};
var baseAction = '{U_ACTION}'.replace(/&amp;/g, '&');

// === FILTRE SESSIONS (cases a cocher humains/robots) ===
function filterSessions() {
    var showHumans = document.getElementById('filter-sessions-humans').checked;
    var showBots = document.getElementById('filter-sessions-bots').checked;
    var rows = document.querySelectorAll('#sessions-table tbody tr[data-type]');
    for (var i = 0; i < rows.length; i++) {
        var type = rows[i].getAttribute('data-type');
        if (type === 'human') {
            rows[i].style.display = showHumans ? '' : 'none';
        } else if (type === 'bot') {
            rows[i].style.display = showBots ? '' : 'none';
        }
    }
}

// === FILTRES ===
function applyFilters() {
    var hours = document.getElementById('filter-hours').value;
    var showBots = document.getElementById('filter-bots').checked ? 1 : 0;
    var limit = document.getElementById('filter-limit').value;
    var sep = (baseAction.indexOf('?') > -1) ? '&' : '?';
    window.location.href = baseAction + sep + 'hours=' + hours + '&show_bots=' + showBots + '&limit=' + limit;
}

// === ONGLETS ===
function openTab(evt, tabName) {
    var tabcontent = document.getElementsByClassName('tab-content');
    for (var i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = 'none';
    }
    var tablinks = document.getElementsByClassName('tab-btn');
    for (var i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(' active', '');
    }
    document.getElementById(tabName).style.display = 'block';
    evt.currentTarget.className += ' active';

    if (tabName === 'tab_map' && !window.mapInitialized) {
        loadAndInitMap();
    }
    return false;
}

// === CARTE (chargement paresseux) ===
function loadAndInitMap() {
    document.getElementById('world-map-humans').innerHTML = '<p style="text-align:center; padding:50px; color:#999;">{L_STATS_MAP_LOADING}</p>';
    document.getElementById('world-map-bots').innerHTML = '<p style="text-align:center; padding:50px; color:#999;">{L_STATS_MAP_LOADING}</p>';

    var css = document.createElement('link');
    css.rel = 'stylesheet';
    css.href = 'https://cdn.jsdelivr.net/npm/jvectormap@2.0.4/jquery-jvectormap.min.css';
    document.head.appendChild(css);

    loadScript('https://cdn.jsdelivr.net/npm/jvectormap@2.0.4/jquery-jvectormap.min.js', function() {
        loadScript('https://cdn.jsdelivr.net/npm/jvectormap@2.0.4/tests/assets/jquery-jvectormap-world-mill-en.js', function() {
            initDualMaps();
        });
    });
}

function loadScript(url, callback) {
    var script = document.createElement('script');
    script.src = url;
    script.onload = callback;
    script.onerror = function() {
        document.getElementById('world-map-humans').innerHTML = '<p style="text-align:center; padding:50px; color:#e74c3c;">{L_STATS_MAP_ERROR}</p>';
    };
    document.body.appendChild(script);
}

function initSingleMap(containerId, data, colors, bgColor, statsCountId, statsGeoId, label, labelPlural) {
    var upper = {};
    var total = 0, countries = 0;
    for (var code in data) {
        if (data.hasOwnProperty(code)) {
            upper[code.toUpperCase()] = data[code];
            total += data[code];
            countries++;
        }
    }
    if (statsCountId) document.getElementById(statsCountId).textContent = countries;
    if (statsGeoId) document.getElementById(statsGeoId).textContent = total;

    jQuery('#' + containerId).vectorMap({
        map: 'world_mill_en',
        backgroundColor: bgColor,
        zoomOnScroll: true,
        zoomButtons: true,
        panOnDrag: true,
        regionStyle: {
            initial: { fill: '#e0e0e0', 'fill-opacity': 1, stroke: '#fff', 'stroke-width': 0.5, 'stroke-opacity': 1 },
            hover: { 'fill-opacity': 0.8, cursor: 'pointer' }
        },
        series: {
            regions: [{
                values: upper,
                scale: colors,
                normalizeFunction: 'polynomial',
                min: 0,
                max: Math.max.apply(null, Object.values(upper)) || 1
            }]
        },
        onRegionTipShow: function(e, el, code) {
            var v = upper[code] || 0;
            if (v > 0) {
                el.html('<strong>' + el.html() + '</strong><br>' + v + ' ' + (v > 1 ? labelPlural : label));
            }
        }
    });
}

function initDualMaps() {
    if (typeof jQuery === 'undefined' || typeof jQuery.fn.vectorMap === 'undefined') {
        document.getElementById('world-map-humans').innerHTML = '<p style="color:#e74c3c; text-align:center; padding:50px;">{L_STATS_MAP_UNAVAILABLE}</p>';
        return;
    }
    initSingleMap('world-map-humans', mapDataHumans, ['#bbdefb', '#42a5f5', '#1565c0'], '#f8fafc', 'total-countries-humans', 'total-geolocated-humans', '{L_STATS_MAP_VISITOR}', '{L_STATS_MAP_VISITORS}');
    initSingleMap('world-map-bots', mapDataBots, ['#ffcdd2', '#ef5350', '#b71c1c'], '#fff5f5', 'total-countries-bots', 'total-geolocated-bots', '{L_STATS_MAP_BOT_LABEL}', '{L_STATS_MAP_BOTS_LABEL}');
    window.mapInitialized = true;
}
</script>
